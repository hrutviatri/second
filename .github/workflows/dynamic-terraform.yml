name: ğŸ§© Terraform Dynamic Chain

on:
  workflow_dispatch:
    inputs:
      run_init:
        type: boolean
        default: false
        description: "Run terraform init?"
      run_plan:
        type: boolean
        default: false
        description: "Run terraform plan?"
      run_apply:
        type: boolean
        default: false
        description: "Run terraform apply?"
      run_destroy:
        type: boolean
        default: false
        description: "Run terraform destroy?"

env:
  WORKDIR: infra

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_init: ${{ inputs.run_init }}
      run_plan: ${{ inputs.run_plan }}
      run_apply: ${{ inputs.run_apply }}
      run_destroy: ${{ inputs.run_destroy }}
    steps:
      - run: echo "Setup done âœ…"

  # INIT
  init:
    if: ${{ needs.setup.outputs.run_init == 'true' }}
    needs: [setup]
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ—ï¸ Running terraform init"

  # PLAN
  plan:
    needs: ${{ fromJson('["setup"]') }}
    if: ${{ needs.setup.outputs.run_plan == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Set dependency dynamically
        id: dyn
        run: |
          echo "INIT_SELECTED=${{ needs.setup.outputs.run_init }}" 
          if [ "${{ needs.setup.outputs.run_init }}" = "true" ]; then
            echo "needs_init=true" >> $GITHUB_OUTPUT
          else
            echo "needs_init=false" >> $GITHUB_OUTPUT
          fi
      - name: Run Plan
        run: echo "ğŸ“˜ Terraform Plan running..."

  # APPLY
  apply:
    needs: ${{ fromJson('["setup"]') }}
    if: ${{ needs.setup.outputs.run_apply == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for dependencies
        run: |
          if [ "${{ needs.setup.outputs.run_plan }}" = "true" ]; then
            echo "â³ Waiting for PLAN to finish..."
          elif [ "${{ needs.setup.outputs.run_init }}" = "true" ]; then
            echo "â³ Waiting for INIT to finish..."
          else
            echo "ğŸš€ No dependency, running directly."
          fi
      - run: echo "âœ… Terraform Apply executed"

  # DESTROY
  destroy:
    needs: ${{ fromJson('["setup"]') }}
    if: ${{ needs.setup.outputs.run_destroy == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Determine order
        run: |
          echo "ğŸ§¹ Destroy job started"
          if [ "${{ needs.setup.outputs.run_apply }}" = "true" ]; then
            echo "â›“ Depends on Apply"
          elif [ "${{ needs.setup.outputs.run_plan }}" = "true" ]; then
            echo "â›“ Depends on Plan"
          elif [ "${{ needs.setup.outputs.run_init }}" = "true" ]; then
            echo "â›“ Depends on Init"
          else
            echo "ğŸ§¹ Running Destroy alone"
          fi
      - run: echo "ğŸ’£ Terraform Destroy completed"
