name: terraform-multi

on:
  workflow_call:
    inputs:
      environment:      { type: string,  required: true }
      tfvars_file:      { type: string,  required: true }
      rgname:           { type: string,  required: true }
      saname:           { type: string,  required: true }
      scname:           { type: string,  required: true }
      key:              { type: string,  required: true }

      runInit:          { type: boolean, default: false }
      runPlan:          { type: boolean, default: false }
      runApply:         { type: boolean, default: false }
      runDestroy:       { type: boolean, default: false }

      useEnvironmentInit:    { type: boolean, default: false }
      useEnvironmentPlan:    { type: boolean, default: false }
      useEnvironmentApply:   { type: boolean, default: false }
      useEnvironmentDestroy: { type: boolean, default: false }

    secrets:
      CLI_ID:       { required: true }
      TEN_ID:       { required: true }
      SUB_IS: { required: true }

permissions:
  id-token: write
  contents: read

env:
  WORKDIR: infra

jobs:


  setup:
    runs-on: ubuntu-latest
    outputs:
      destroy_needs: ${{ steps.set.outputs.destroy_needs }}
    steps:
      - id: set
        run: |
          echo "Computing dynamic dependencies..."
          DEPS='[]'
          if [[ "${{ inputs.runApply }}" == "true" ]]; then DEPS='["apply"]'; fi
          if [[ "${{ inputs.runPlan }}" == "true" ]]; then DEPS='["plan"]'; fi
          if [[ "${{ inputs.runInit }}" == "true" ]]; then DEPS='["init"]'; fi
          echo "destroy_needs=$DEPS" >> $GITHUB_OUTPUT


  # 1Ô∏è‚É£ INIT + FMT + VALIDATE
  init:
    if: ${{ inputs.runInit }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentInit && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLI_ID }}
          tenant-id: ${{ secrets.TEN_ID }}
          subscription-id: ${{ secrets.SUB_IS }}

      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      - run: terraform fmt -recursive
      - run: terraform validate


  # 2Ô∏è‚É£ PLAN
  # plan:
  #   needs: [init]
  #   if: ${{ inputs.runPlan && (needs.init.result == 'success' || !inputs.runInit) }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.useEnvironmentPlan && inputs.environment || '' }}
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKDIR }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.CLI_ID }}
  #         tenant-id: ${{ secrets.TEN_ID }}
  #         subscription-id: ${{ secrets.SUB_IS }}

  #     - name: Terraform Init
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

  #     - name: Terraform Plan
  #       run: terraform plan -var-file="../${{ inputs.tfvars_file }}" -out="plan-${{ inputs.environment }}.tfplan"

  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: tfplan-${{ inputs.environment }}
  #         path: infra/plan-${{ inputs.environment }}.tfplan
  plan:
    name: Terraform Plan
    # needs: [init_fmt_validate]
    needs: [init]
    if: ${{ inputs.runPlan && (needs.init.result == 'success' || !inputs.runInit) }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentPlan && inputs.environment || '' }}

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLI_ID }}
          tenant-id: ${{ secrets.TEN_ID }}
          subscription-id: ${{ secrets.SUB_IS }}

      # - name: Terraform Init (Backend)
      #   run: |
      #     terraform init -input=false \
      #       -backend-config="resource_group_name=ritkargv" \
      #       -backend-config="storage_account_name=ritkasav" \
      #       -backend-config="container_name=ritkascv" \
      #       -backend-config="key=prod.tfstate"

      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"


      # - name: Terraform Plan
      #   run: terraform plan -var-file="../environments/prod.tfvars" -out="plan-prod.tfplan"

      - name: Terraform Plan
        run: terraform plan -var-file="../environments/prod.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"


      # - name: Upload Plan Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: prod-tfplan         # üëà must match apply job name
      #     path: |
      #       infra/plan-prod.tfplan
      #       infra/.terraform.lock.hcl
      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: infra/tf-plan-${{ inputs.environment }}.tfplan

            

  # 3Ô∏è‚É£ APPLY
  apply:
    needs: [plan]
    if: ${{ inputs.runApply && needs.plan.result == 'success' }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentApply && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLI_ID }}
          tenant-id: ${{ secrets.TEN_ID }}
          subscription-id: ${{ secrets.SUB_IS }}

      # - uses: actions/download-artifact@v4
      #   with:
      #     name: tfplan-${{ inputs.environment }}
      #     path: infra

      # - name: Terraform Apply
      #   run: terraform apply -auto-approve "plan-${{ inputs.environment }}.tfplan"


      # - name: Download Plan
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: prod-tfplan
      #     path: infra

      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: infra


      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      # - name: Terraform Apply
      #   if: ${{ inputs.require_approval || github.event_name == 'push' }}
      #   run: terraform apply -auto-approve "prod.tfplan"

      
      - name: Terraform Apply
        if: ${{ inputs.require_approval || github.event_name == 'push' }}
        run: terraform apply -auto-approve "tf-plan-${{ inputs.environment }}"


  # # 4Ô∏è‚É£ DESTROY
  # destroy:
  #   needs: [apply]
  #   if: ${{ inputs.runDestroy && needs.apply.result == 'success' }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.useEnvironmentDestroy && inputs.environment || '' }}
  #   defaults:
  #     run:
  #       working-directory: ${{ env.WORKDIR }}
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: azure/login@v2
  #       with:
  #         client-id: ${{ secrets.CLI_ID }}
  #         tenant-id: ${{ secrets.TEN_ID }}
  #         subscription-id: ${{ secrets.SUB_IS }}

  #     - name: Terraform Init
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
      
  #     - name: Terraform Destroy
  #       run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"







  # 4Ô∏è‚É£ DESTROY
 destroy:
    if: ${{ inputs.runDestroy }}
    needs: [setup]
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentDestroy && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}

    steps:
      - name: Read dynamic dependency
        id: read
        run: |
          echo "Destroy will depend on: ${{ needs.setup.outputs.destroy_needs }}"

      - run: echo "üî• Terraform destroy"

      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.CLI_ID }}
          tenant-id: ${{ secrets.TEN_ID }}
          subscription-id: ${{ secrets.SUB_IS }}

      - name: Terraform Init
        run: terraform init -input=false \
          -backend-config="resource_group_name=${{ inputs.rgname }}" \
          -backend-config="storage_account_name=${{ inputs.saname }}" \
          -backend-config="container_name=${{ inputs.scname }}" \
          -backend-config="key=${{ inputs.key }}"

      - name: Terraform Destroy
        run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"